name: Deploy Portfolio and Update Projects

on:
  push:
    branches:
      - main
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  update-projects:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch pinned repositories
        id: fetch-repos
        run: |
          # Fetch user's repositories
          echo "Fetching repositories for brianwalkerdev..."
          
          # Get all repos sorted by update date
          REPOS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/users/brianwalkerdev/repos?sort=updated&per_page=100")
          
          # Create projects.json with repo data
          echo "$REPOS" | jq '[.[] | select(.fork == false and .archived == false) | {
            name: .name,
            description: (.description // "No description available"),
            updated: .updated_at,
            url: .html_url,
            homepage: (.homepage // ("/" + .name + "/")),
            thumbnail: ("assets/img/" + .name + ".png")
          }] | sort_by(.updated) | reverse | .[0:10]' > projects.json
          
          echo "Projects updated successfully"
          cat projects.json

      - name: Commit updated projects.json
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if git diff --quiet projects.json; then
            echo "No changes to projects.json"
          else
            git add projects.json
            git commit -m "Update projects.json with latest repositories"
            git push
          fi

  build-and-deploy-projects:
    needs: update-projects
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create dist directory
        run: mkdir -p dist

      - name: Copy main site files
        run: |
          cp index.html dist/
          cp projects.json dist/
          cp -r assets dist/

      - name: Read projects and build each
        run: |
          # Read projects from projects.json
          PROJECTS=$(cat projects.json | jq -r '.[].name')
          
          for PROJECT in $PROJECTS; do
            echo "Processing project: $PROJECT"
            
            # Check if repo exists
            if curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/brianwalkerdev/$PROJECT" | jq -e '.name' > /dev/null; then
              
              echo "Cloning $PROJECT..."
              git clone "https://github.com/brianwalkerdev/$PROJECT.git" "/tmp/$PROJECT" || continue
              
              cd "/tmp/$PROJECT"
              
              # Check if it's a Node.js project
              if [ -f "package.json" ]; then
                echo "Building Node.js project: $PROJECT"
                npm install || true
                npm run build || npm run build:prod || true
                
                # Look for common build output directories
                if [ -d "dist" ]; then
                  mkdir -p "$GITHUB_WORKSPACE/dist/$PROJECT"
                  cp -r dist/* "$GITHUB_WORKSPACE/dist/$PROJECT/" || true
                elif [ -d "build" ]; then
                  mkdir -p "$GITHUB_WORKSPACE/dist/$PROJECT"
                  cp -r build/* "$GITHUB_WORKSPACE/dist/$PROJECT/" || true
                elif [ -d "public" ]; then
                  mkdir -p "$GITHUB_WORKSPACE/dist/$PROJECT"
                  cp -r public/* "$GITHUB_WORKSPACE/dist/$PROJECT/" || true
                fi
              else
                # For non-Node projects, just copy the repo as-is
                mkdir -p "$GITHUB_WORKSPACE/dist/$PROJECT"
                cp -r . "$GITHUB_WORKSPACE/dist/$PROJECT/" || true
              fi
              
              cd "$GITHUB_WORKSPACE"
            else
              echo "Project $PROJECT not found or not accessible"
            fi
          done

      - name: Create .nojekyll file
        run: touch dist/.nojekyll

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'dist'

  deploy:
    needs: build-and-deploy-projects
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
